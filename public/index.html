<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>á€á˜áŸ’á˜áœá·á’á¸áá¶á˜áŠá¶á“á…áŸ†áá¶á™á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Do NOT include external telegram-web-app.js; Telegram injects the WebApp object. -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f2f2f7;
            --text-color: #000000;
            --hint-color: #999999;
            --button-color: #007aff;
            --button-text-color: #ffffff;
            --secondary-bg-color: #ffffff;
            --danger-color: #ff3b30;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        #app-container {
            height: 100vh;
            overflow-y: auto;
            background-color: var(--bg-color);
        }

        .header {
            background-color: var(--secondary-bg-color);
            padding: 1rem;
            border-bottom: 1px solid var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .date-header {
            padding: 0.75rem 1rem 0.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .content-card {
            background-color: var(--secondary-bg-color);
            margin: 0 1rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--bg-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item:active {
            background-color: var(--bg-color);
        }

        .fab {
            position: fixed;
            bottom: calc(2rem + env(safe-area-inset-bottom, 0));
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--button-color);
            color: var(--button-text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.3s ease;
            z-index: 15;
        }
        .fab:active {
            transform: scale(0.95);
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.4);
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .modal-content {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            border-top-left-radius: 1.25rem;
            border-top-right-radius: 1.25rem;
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 30;
        }
        .modal-content.open {
            transform: translateY(0);
        }
        .modal-handle {
            width: 40px;
            height: 5px;
            background-color: var(--hint-color);
            border-radius: 2.5px;
            margin: 0.25rem auto 1rem;
            opacity: 0.5;
        }
        
        input[type="date"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header class="header">
            <div class="flex justify-between items-center mb-4">
                <p id="welcome-message" class="text-lg font-semibold">áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸ!</p>
                <button id="generate-report" class="px-3 py-1.5 rounded-lg text-sm flex items-center gap-2" style="background-color: var(--button-color); color: var(--button-text-color);">
                    <span>ášá”á¶á™á€á¶ášááŸ</span>
                    <span>ğŸ“Š</span>
                </button>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div>
                    <p class="text-sm" style="color: var(--hint-color);">ááŸ’á„áŸƒá“áŸáŸ‡</p>
                    <p id="total-today" class="font-bold text-lg">áŸ›áŸ </p>
                </div>
                <div>
                    <p class="text-sm" style="color: var(--hint-color);">áŸá”áŸ’áá¶á áŸá“áŸáŸ‡</p>
                    <p id="total-week" class="font-bold text-lg">áŸ›áŸ </p>
                </div>
                <div>
                    <p class="text-sm" style="color: var(--hint-color);">ááŸ‚á“áŸáŸ‡</p>
                    <p id="total-month" class="font-bold text-lg">áŸ›áŸ </p>
                </div>
            </div>
        </header>

        <main id="main-content" class="pb-32">
             <div class="content-card p-4 mt-4">
                <h2 class="text-lg font-semibold mb-2">á…áŸ†áá¶á™á”áŸ’ášá…á¶áŸ†ááŸ‚á“áŸáŸ‡</h2>
                <canvas id="expense-chart"></canvas>
             </div>
             <div id="history-placeholder" class="text-center py-16 px-4" style="color: var(--hint-color);">
                <p class="text-lg">á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á€á¶ášá…áŸ†áá¶á™á‘áŸáŸ”</p>
                <p class="mt-2">á…á»á…á”áŸŠá¼áá»á„ (+) áŠá¾á˜áŸ’á”á¸á”á“áŸ’ááŸ‚á˜á€á¶ášá…áŸ†áá¶á™áŠáŸ†á”á¼á„ášá”áŸáŸ‹á¢áŸ’á“á€áŸ”</p>
            </div>
        </main>

        <div id="fab" class="fab" title="á”á“áŸ’ááŸ‚á˜á…áŸ†áá¶á™">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="modal-overlay" class="modal-overlay hidden"></div>
    <div id="modal-content" class="modal-content">
        <div class="modal-handle"></div>
        <h2 id="modal-title" class="text-xl font-bold text-center mb-4"></h2>
        <form id="expense-form" class="space-y-4">
            <input type="number" id="amount-input" placeholder="áŸ›0" class="w-full text-4xl font-bold p-2 text-center border-0 bg-transparent" required>
            <div class="grid grid-cols-2 gap-4">
                <select id="category-select" class="w-full p-3 border-0 rounded-lg" style="background-color: var(--secondary-bg-color);" required></select>
                <input type="date" id="date-input" class="w-full p-3 border-0 rounded-lg" style="background-color: var(--secondary-bg-color);" required>
            </div>
            <input type="text" id="notes-input" class="w-full p-3 border-0 rounded-lg" style="background-color: var(--secondary-bg-color);" placeholder="á€áŸ†áááŸ‹á…áŸ†áá¶áŸ† (á”á¾á˜á¶á“)">
            <input type="hidden" id="expense-id-input">
        </form>
    </div>

    <!-- Report Configuration Modal -->
    <div id="report-modal-overlay" class="modal-overlay hidden"></div>
    <div id="report-modal-content" class="modal-content">
        <div class="modal-handle"></div>
        <h2 class="text-xl font-bold text-center mb-4">á”á„áŸ’á€á¾áášá”á¶á™á€á¶ášááŸ</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-color);">á‡áŸ’ášá¾áŸášá¾áŸášá™áŸˆá–áŸá›</label>
                <select id="report-period-select" class="w-full p-3 border-0 rounded-lg" style="background-color: var(--secondary-bg-color);">
                    <option value="today">ááŸ’á„áŸƒá“áŸáŸ‡</option>
                    <option value="yesterday">á˜áŸ’áŸá·á›á˜á·á‰</option>
                    <option value="week">áŸá”áŸ’áá¶á áŸá“áŸáŸ‡</option>
                    <option value="last-week">áŸá”áŸ’áá¶á áŸá˜á»á“</option>
                    <option value="month" selected>ááŸ‚á“áŸáŸ‡</option>
                    <option value="last-month">ááŸ‚á˜á»á“</option>
                    <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                </select>
            </div>
            <button id="generate-report-confirm" class="w-full p-3 rounded-lg font-semibold" style="background-color: var(--button-color); color: var(--button-text-color);">
                á”á„áŸ’á€á¾áášá”á¶á™á€á¶ášááŸ
            </button>
            <button id="close-report-modal" class="w-full p-3 rounded-lg font-semibold" style="background-color: var(--bg-color); color: var(--text-color);">
                á”áŸ„áŸ‡á”á„áŸ‹
            </button>
        </div>
    </div>

    <script>
        function initializeApp() {
            // Use injected Telegram WebApp if present; otherwise tg=null and we operate in fallback/local mode.
            const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
            const isStorageSupported = tg && typeof tg.isVersionAtLeast === 'function' && tg.isVersionAtLeast('6.9');

            const state = {
                expenses: [],
                categories: [
                    { id: 'food', name: 'á¢á¶á á¶áš', icon: 'ğŸ”', color: '#FF6384' },
                    { id: 'transport', name: 'á€á¶ášá’áŸ’áœá¾áŠáŸ†áá¾áš', icon: 'ğŸ›µ', color: '#36A2EB' },
                    { id: 'bills', name: 'áœá·á€áŸ’á€á™á”ááŸ’áš', icon: 'ğŸ§¾', color: '#FFCE56' },
                    { id: 'shopping', name: 'á€á¶ášáŠá¾ášá‘á·á‰á¥áœáŸ‰á¶á“áŸ‹', icon: 'ğŸ›ï¸', color: '#4BC0C0' },
                    { id: 'entertainment', name: 'á€á¶ášá€á˜áŸ’áŸá¶á“áŸ’á', icon: 'ğŸ¬', color: '#9966FF' },
                    { id: 'other', name: 'á•áŸ’áŸáŸá„áŸ—', icon: 'ğŸ’¸', color: '#C9CBCF' },
                ],
                chartInstance: null,
            };
            
            // UI Elements
            const welcomeMessageEl = document.getElementById('welcome-message');
            const totalTodayEl = document.getElementById('total-today');
            const totalWeekEl = document.getElementById('total-week');
            const totalMonthEl = document.getElementById('total-month');
            const mainContent = document.getElementById('main-content');
            const historyPlaceholder = document.getElementById('history-placeholder');
            const chartCanvas = document.getElementById('expense-chart').getContext('2d');
            const fab = document.getElementById('fab');
            const generateReportBtn = document.getElementById('generate-report');

            // Modal Elements
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const expenseForm = document.getElementById('expense-form');
            const amountInput = document.getElementById('amount-input');
            const categorySelect = document.getElementById('category-select');
            const dateInput = document.getElementById('date-input');
            const notesInput = document.getElementById('notes-input');
            const expenseIdInput = document.getElementById('expense-id-input');

            // Report Modal Elements
            const reportModalOverlay = document.getElementById('report-modal-overlay');
            const reportModalContent = document.getElementById('report-modal-content');
            const reportPeriodSelect = document.getElementById('report-period-select');
            const generateReportConfirm = document.getElementById('generate-report-confirm');
            const closeReportModal = document.getElementById('close-report-modal');

            // --- Helper utilities for CloudStorage ---
            function cloudSetItemPromise(key, value) {
                return new Promise((resolve, reject) => {
                    try {
                        if (!tg || !tg.CloudStorage || !tg.CloudStorage.setItem) {
                            reject(new Error('CloudStorage not available'));
                            return;
                        }
                        tg.CloudStorage.setItem(key, value, (err) => {
                            if (err) reject(err);
                            else resolve();
                        });
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            function cloudGetItemsPromise(keys) {
                return new Promise((resolve, reject) => {
                    try {
                        if (!tg || !tg.CloudStorage || !tg.CloudStorage.getItems) {
                            reject(new Error('CloudStorage not available'));
                            return;
                        }
                        tg.CloudStorage.getItems(keys, (err, values) => {
                            if (err) reject(err);
                            else resolve(values || {});
                        });
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            // Byte-aware length and chunking to avoid splitting UTF-8 characters
            function utf8ByteLength(str) {
                return new TextEncoder().encode(str).length;
            }

            function chunkStringByByteSize(str, maxBytes) {
                const chunks = [];
                let current = '';
                let currentBytes = 0;
                for (let i = 0; i < str.length; i++) {
                    const ch = str[i];
                    const chBytes = utf8ByteLength(ch);
                    if (currentBytes + chBytes > maxBytes) {
                        if (current === '') {
                            chunks.push(ch);
                            current = '';
                            currentBytes = 0;
                        } else {
                            chunks.push(current);
                            current = ch;
                            currentBytes = chBytes;
                        }
                    } else {
                        current += ch;
                        currentBytes += chBytes;
                    }
                }
                if (current.length > 0) chunks.push(current);
                return chunks;
            }

            const MAX_CHUNK_BYTES = 3500;

            // --- UI Rendering ---
            function applyTheme() {
                try {
                    const themeParams = (tg && tg.themeParams) ? tg.themeParams : {};
                    const styles = {
                        '--bg-color': themeParams.secondary_bg_color || '#f2f2f7',
                        '--text-color': themeParams.text_color || '#000000',
                        '--hint-color': themeParams.hint_color || '#999999',
                        '--button-color': themeParams.button_color || '#007aff',
                        '--button-text-color': themeParams.button_text_color || '#ffffff',
                        '--secondary-bg-color': themeParams.bg_color || '#ffffff',
                    };
                    for (const [key, value] of Object.entries(styles)) {
                        document.documentElement.style.setProperty(key, value);
                    }
                    if (tg && tg.setHeaderColor) tg.setHeaderColor(themeParams.bg_color || '#ffffff');
                } catch (e) {
                    // ignore
                }
            }
            
            function formatCurrency(amount) {
                try {
                    return new Intl.NumberFormat('km-KH', { style: 'currency', currency: 'KHR', minimumFractionDigits: 0 }).format(amount);
                } catch (e) {
                    return `áŸ›${Math.round(amount)}`;
                }
            }

            function getCurrencySymbol() { return 'áŸ›'; }

            function render() {
                renderSummaries();
                renderExpenseHistory();
                renderCategoriesInDropdown();
                renderChart();
                amountInput.placeholder = `${getCurrencySymbol()}0`;
            }

            function renderSummaries() {
                const now = new Date();
                const todayStr = now.toISOString().slice(0, 10);
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - (now.getDay() || 7) + 1);
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                const totalToday = state.expenses.filter(e => e.date.startsWith(todayStr)).reduce((s, e) => s + e.amount, 0);
                const totalWeek = state.expenses.filter(e => new Date(e.date) >= startOfWeek).reduce((s, e) => s + e.amount, 0);
                const totalMonth = state.expenses.filter(e => new Date(e.date) >= startOfMonth).reduce((s, e) => s + e.amount, 0);

                totalTodayEl.textContent = formatCurrency(totalToday);
                totalWeekEl.textContent = formatCurrency(totalWeek);
                totalMonthEl.textContent = formatCurrency(totalMonth);
            }

            function renderChart() {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthlyExpenses = state.expenses.filter(e => new Date(e.date) >= startOfMonth);
                const categoryTotals = state.categories.map(cat => ({
                    ...cat,
                    total: monthlyExpenses.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount, 0)
                })).filter(cat => cat.total > 0);

                if (state.chartInstance) state.chartInstance.destroy();
                state.chartInstance = new Chart(chartCanvas, {
                    type: 'pie', data: {
                        labels: categoryTotals.map(c => c.name),
                        datasets: [{
                            data: categoryTotals.map(c => c.total),
                            backgroundColor: categoryTotals.map(c => c.color),
                            borderColor: 'var(--secondary-bg-color)', borderWidth: 2
                        }]
                    }, options: { responsive: true, plugins: { legend: { position: 'right', labels: { font: { family: "'Kantumruy Pro', sans-serif" } } } } }
                });
            }

            function renderExpenseHistory() {
                mainContent.querySelector('#history-placeholder')?.remove();
                mainContent.querySelectorAll('.date-header, .content-card.expense-list-container').forEach(el => el.remove());
                
                if (state.expenses.length === 0) {
                    mainContent.insertAdjacentElement('beforeend', historyPlaceholder);
                    return;
                }

                const grouped = state.expenses.reduce((acc, expense) => {
                    const date = expense.date.slice(0, 10);
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(expense);
                    return acc;
                }, {});

                const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
                const todayStr = new Date().toISOString().slice(0, 10);
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().slice(0, 10);

                sortedDates.forEach(dateStr => {
                    let label = (dateStr === todayStr) ? 'ááŸ’á„áŸƒá“áŸáŸ‡' : (dateStr === yesterdayStr) ? 'á˜áŸ’áŸá·á›á˜á·á‰' : new Date(dateStr).toLocaleDateString('km-KH', { day: 'numeric', month: 'short', year: 'numeric' });
                    
                    const dateHeader = document.createElement('h2');
                    dateHeader.className = 'date-header text-lg'; dateHeader.textContent = label;
                    mainContent.appendChild(dateHeader);

                    const listContainer = document.createElement('div');
                    listContainer.className = 'content-card expense-list-container';
                    
                    grouped[dateStr].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                        const category = state.categories.find(c => c.id === expense.category);
                        const item = document.createElement('div');
                        item.className = 'list-item'; item.dataset.id = expense.id;
                        item.innerHTML = `
                            <div class="text-2xl mr-4">${category?.icon || 'ğŸ’¸'}</div>
                            <div class="flex-grow">
                                <p class="font-semibold">${category?.name || 'á”áŸ’ášá—áŸá‘â€‹áŠáŸ‚á›â€‹á”á¶á“â€‹á›á»á”'}</p>
                                ${expense.notes ? `<p class="text-sm" style="color: var(--hint-color);">${expense.notes}</p>` : ''}
                            </div>
                            <div class="font-semibold text-right">${formatCurrency(expense.amount)}</div>`;
                        listContainer.appendChild(item);
                    });
                    mainContent.appendChild(listContainer);
                });
            }
            
            function renderCategoriesInDropdown() {
                categorySelect.innerHTML = '<option value="" disabled>-- á‡áŸ’ášá¾áŸášá¾áŸá”áŸ’ášá—áŸá‘ --</option>';
                state.categories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`;
                });
            }

            // --- Modals ---
            function openModal(expense = null) {
                if (expense) {
                    modalTitle.textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›á…áŸ†áá¶á™';
                    amountInput.value = expense.amount;
                    categorySelect.value = expense.category;
                    notesInput.value = expense.notes;
                    dateInput.value = expense.date.slice(0, 10);
                    expenseIdInput.value = expense.id;
                    if (tg && tg.MainButton && tg.MainButton.setText) tg.MainButton.setText('á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–');
                } else {
                    modalTitle.textContent = 'á”á“áŸ’ááŸ‚á˜á…áŸ†áá¶á™ááŸ’á˜á¸';
                    expenseForm.reset();
                    renderCategoriesInDropdown();
                    dateInput.value = new Date().toISOString().slice(0, 10);
                    expenseIdInput.value = '';
                    if (tg && tg.MainButton && tg.MainButton.setText) tg.MainButton.setText('ášá€áŸ’áŸá¶á‘á»á€á…áŸ†áá¶á™');
                }
                modalOverlay.classList.remove('hidden');
                modalContent.classList.add('open');
                if (tg && tg.MainButton && tg.MainButton.show) tg.MainButton.show();
                if (tg && tg.HapticFeedback && tg.HapticFeedback.impactOccurred) tg.HapticFeedback.impactOccurred('light');
            }

            function closeModal() {
                modalOverlay.classList.add('hidden');
                modalContent.classList.remove('open');
                if (tg && tg.MainButton && tg.MainButton.hide) tg.MainButton.hide();
            }

            function openReportModal() {
                reportModalOverlay.classList.remove('hidden');
                reportModalContent.classList.add('open');
                if (tg && tg.HapticFeedback && tg.HapticFeedback.impactOccurred) tg.HapticFeedback.impactOccurred('light');
            }

            function closeReportModalFunc() {
                reportModalOverlay.classList.add('hidden');
                reportModalContent.classList.remove('open');
            }

            function getDateRange(period) {
                const now = new Date();
                let startDate, endDate, periodLabel;

                switch(period) {
                    case 'today':
                        startDate = new Date(now.setHours(0, 0, 0, 0));
                        endDate = new Date(now.setHours(23, 59, 59, 999));
                        periodLabel = 'ááŸ’á„áŸƒá“áŸáŸ‡';
                        break;
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        startDate = new Date(yesterday.setHours(0, 0, 0, 0));
                        endDate = new Date(yesterday.setHours(23, 59, 59, 999));
                        periodLabel = 'á˜áŸ’áŸá·á›á˜á·á‰';
                        break;
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - (now.getDay() || 7) + 1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(now.setHours(23, 59, 59, 999));
                        periodLabel = 'áŸá”áŸ’áá¶á áŸá“áŸáŸ‡';
                        break;
                    case 'last-week':
                        const lastWeekEnd = new Date(now);
                        lastWeekEnd.setDate(now.getDate() - (now.getDay() || 7));
                        lastWeekEnd.setHours(23, 59, 59, 999);
                        startDate = new Date(lastWeekEnd);
                        startDate.setDate(lastWeekEnd.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = lastWeekEnd;
                        periodLabel = 'áŸá”áŸ’áá¶á áŸá˜á»á“';
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.setHours(23, 59, 59, 999));
                        periodLabel = now.toLocaleDateString('km-KH', {month: 'long', year: 'numeric'});
                        break;
                    case 'last-month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                        periodLabel = startDate.toLocaleDateString('km-KH', {month: 'long', year: 'numeric'});
                        break;
                    case 'all':
                        startDate = new Date(0);
                        endDate = new Date(now.setHours(23, 59, 59, 999));
                        periodLabel = 'á‘á¶áŸ†á„á¢áŸáŸ‹';
                        break;
                    default:
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.setHours(23, 59, 59, 999));
                        periodLabel = 'ááŸ‚á“áŸáŸ‡';
                }

                return { startDate, endDate, periodLabel };
            }

            function generateDetailedReport() {
                if (state.expenses.length === 0) {
                    if (tg && tg.showAlert) tg.showAlert('á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á”á„áŸ’á€á¾áášá”á¶á™á€á¶ášááŸá‘áŸáŸ”');
                    else alert('No data for report.');
                    return;
                }

                const period = reportPeriodSelect.value;
                const { startDate, endDate, periodLabel } = getDateRange(period);
                
                const filteredExpenses = state.expenses.filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                });

                if (filteredExpenses.length === 0) {
                    if (tg && tg.showAlert) tg.showAlert('á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹ášá™áŸˆá–áŸá›á“áŸáŸ‡á‘áŸáŸ”');
                    closeReportModalFunc();
                    return;
                }

                const totalAmount = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                const transactionCount = filteredExpenses.length;
                
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const avgPerDay = totalAmount / daysDiff;
                const avgPerTransaction = totalAmount / transactionCount;
                
                const categoryTotals = state.categories.map(cat => ({
                    ...cat,
                    total: filteredExpenses.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount, 0),
                    count: filteredExpenses.filter(e => e.category === cat.id).length
                })).filter(cat => cat.total > 0);

                const sortedExpenses = [...filteredExpenses].sort((a, b) => b.amount - a.amount);
                const highestExpense = sortedExpenses[0];
                const lowestExpense = sortedExpenses[sortedExpenses.length - 1];
                const highestCategory = state.categories.find(c => c.id === highestExpense.category);
                const lowestCategory = state.categories.find(c => c.id === lowestExpense.category);

                let report = `ğŸ“Š ášá”á¶á™á€á¶ášááŸá…áŸ†áá¶á™ - ${periodLabel}\n`;
                report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                
                report += `ğŸ’° á…áŸ†áá¶á™áŸášá»á”áŸ– ${formatCurrency(totalAmount)}\n`;
                report += `ğŸ“ á…áŸ†á“á½á“á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášáŸ– ${transactionCount}\n`;
                report += `ğŸ“… ášá™áŸˆá–áŸá›áŸ– ${daysDiff} ááŸ’á„áŸƒ\n`;
                report += `ğŸ“Š á˜á’áŸ’á™á˜á—á¶á‚á€áŸ’á“á»á„á˜á½á™ááŸ’á„áŸƒáŸ– ${formatCurrency(avgPerDay)}\n`;
                report += `ğŸ’³ á˜á’áŸ’á™á˜á—á¶á‚á€áŸ’á“á»á„á˜á½á™á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášáŸ– ${formatCurrency(avgPerTransaction)}\n\n`;
                
                report += `ğŸ“‹ á…áŸ†áá¶á™áá¶á˜á”áŸ’ášá—áŸá‘áŸ–\n`;
                report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                categoryTotals.sort((a, b) => b.total - a.total).forEach(cat => {
                    const percentage = totalAmount ? ((cat.total / totalAmount) * 100).toFixed(1) : '0.0';
                    report += `${cat.icon} ${cat.name}\n`;
                    report += `   á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹áŸ– ${formatCurrency(cat.total)} (${percentage}%)\n`;
                    report += `   á…áŸ†á“á½á“áŠá„áŸ– ${cat.count}\n\n`;
                });

                report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                report += `ğŸ” á…áŸ†áá¶á™ááŸ’á–áŸáŸ‹á”áŸ†á•á»ááŸ–\n`;
                report += `   ${formatCurrency(highestExpense.amount)} - ${highestCategory?.icon} ${highestCategory?.name}\n`;
                if (highestExpense.notes) report += `   "${highestExpense.notes}"\n`;
                
                report += `\nğŸ”» á…áŸ†áá¶á™á‘á¶á”á”áŸ†á•á»ááŸ–\n`;
                report += `   ${formatCurrency(lowestExpense.amount)} - ${lowestCategory?.icon} ${lowestCategory?.name}\n`;
                if (lowestExpense.notes) report += `   "${lowestExpense.notes}"\n`;

                closeReportModalFunc();

                if (tg && tg.showPopup) {
                    tg.showPopup({
                        title: 'ášá”á¶á™á€á¶ášááŸá…áŸ†áá¶á™',
                        message: report.substring(0, 200) + '...\n\ná…á»á… "á•áŸ’á‰á¾á‘áŸ… Chat" áŠá¾á˜áŸ’á”á¸á˜á¾á›ášá”á¶á™á€á¶ášááŸá–áŸá‰á›áŸá‰',
                        buttons: [
                            {id: 'send', type: 'default', text: 'á•áŸ’á‰á¾á‘áŸ… Chat'},
                            {type: 'cancel', text: 'á”á·á‘'}
                        ]
                    }, (buttonId) => {
                        if (buttonId === 'send') {
                            const initData = tg.initData;
                            fetch('/api/send-report', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ initData: initData, report: report })
                            })
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) {
                                    if (tg.showAlert) tg.showAlert('âœ… ášá”á¶á™á€á¶ášááŸááŸ’ášá¼áœá”á¶á“á•áŸ’á‰á¾áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!');
                                    if (tg && tg.HapticFeedback && tg.HapticFeedback.notificationOccurred) tg.HapticFeedback.notificationOccurred('success');
                                } else {
                                    if (tg && tg.showAlert) tg.showAlert('âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸ');
                                }
                            })
                            .catch(err => {
                                console.error('Error:', err);
                                if (tg && tg.showAlert) tg.showAlert('âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸ');
                            });
                        }
                    });
                } else {
                    alert(report);
                }
            }

            // --- Data Handling (robust chunk-aware) ---
            async function saveDataToCloud(callback) {
                const dataToSave = JSON.stringify(state.expenses || []);

                if (!isStorageSupported) {
                    try { localStorage.setItem('expenses', dataToSave); } catch (e) { console.warn('localStorage not available', e); }
                    if (callback) callback();
                    return;
                }

                // Try single-key first
                try {
                    await cloudSetItemPromise('expenses', dataToSave);
                    if (callback) callback();
                    return;
                } catch (err) {
                    console.warn('Single-key save failed, falling back to chunking:', err);
                }

                // Chunking fallback
                try {
                    const chunks = chunkStringByByteSize(dataToSave, MAX_CHUNK_BYTES);
                    const chunkCount = chunks.length;
                    const writes = [];
                    for (let i = 0; i < chunkCount; i++) writes.push(cloudSetItemPromise(`expenses_chunk_${i}`, chunks[i]));
                    await Promise.all(writes);
                    await cloudSetItemPromise('expenses_chunk_count', String(chunkCount));
                    if (callback) callback();
                } catch (e) {
                    console.error('Chunked save failed:', e);
                    if (tg && tg.showAlert) tg.showAlert(`á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á·á“áŸ’á“á“áŸá™: ${e}`);
                    if (callback) callback();
                }
            }

            async function loadExpensesFromCloud(singleValue) {
                if (singleValue) {
                    try {
                        const parsed = JSON.parse(singleValue);
                        state.expenses = Array.isArray(parsed) ? parsed : [];
                        return;
                    } catch (e) {
                        console.warn('Failed to parse single-key expenses, attempting chunked load.', e);
                    }
                }

                if (!isStorageSupported) {
                    try {
                        const local = localStorage.getItem('expenses');
                        if (local) {
                            const parsed = JSON.parse(local);
                            state.expenses = Array.isArray(parsed) ? parsed : [];
                            return;
                        }
                        state.expenses = [];
                        return;
                    } catch (e) {
                        console.warn('local load failed', e);
                        state.expenses = [];
                        return;
                    }
                }

                try {
                    const values = await cloudGetItemsPromise(['expenses_chunk_count']);
                    const countRaw = values && values.expenses_chunk_count;
                    const count = countRaw ? parseInt(countRaw, 10) : 0;
                    if (!count) { state.expenses = []; return; }
                    const keys = [];
                    for (let i = 0; i < count; i++) keys.push(`expenses_chunk_${i}`);
                    const chunkVals = await cloudGetItemsPromise(keys);
                    let assembled = '';
                    for (let i = 0; i < count; i++) assembled += chunkVals[`expenses_chunk_${i}`] || '';
                    try {
                        const parsed = JSON.parse(assembled);
                        state.expenses = Array.isArray(parsed) ? parsed : [];
                        return;
                    } catch (e) {
                        console.error('Failed to parse assembled chunks', e);
                        state.expenses = [];
                        return;
                    }
                } catch (e) {
                    console.error('Error loading chunked expenses', e);
                    state.expenses = [];
                }
            }

            // --- Handlers ---
            function handleFormSubmit() {
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0 || !categorySelect.value || !dateInput.value) {
                    if (tg && tg.showAlert) tg.showAlert('áŸá¼á˜á”áŸ†á–áŸá‰á‚áŸ’ášá”áŸ‹á…áŸ’ášá€á‘á¶áŸ†á„á¢áŸáŸ‹áŸ”');
                    else alert('Please fill all required fields.');
                    return;
                }
                if (tg && tg.MainButton && tg.MainButton.showProgress) tg.MainButton.showProgress();
                const id = expenseIdInput.value;
                const date = new Date(dateInput.value).toISOString();
                if (id) {
                    const index = state.expenses.findIndex(e => e.id === id);
                    if (index > -1) state.expenses[index] = { ...state.expenses[index], amount, category: categorySelect.value, notes: notesInput.value.trim(), date };
                } else {
                    const newId = (self && self.crypto && self.crypto.randomUUID) ? self.crypto.randomUUID() : String(Date.now()) + Math.random().toString(36).slice(2);
                    state.expenses.push({ id: newId, amount, category: categorySelect.value, notes: notesInput.value.trim(), date });
                }
                saveDataToCloud(() => { render(); closeModal(); if (tg && tg.MainButton && tg.MainButton.hideProgress) tg.MainButton.hideProgress(); if (tg && tg.HapticFeedback && tg.HapticFeedback.notificationOccurred) tg.HapticFeedback.notificationOccurred('success'); });
            }

            function deleteExpense(id) {
                if (tg && tg.showConfirm) {
                    tg.showConfirm('áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á€á¶ášá…áŸ†áá¶á™á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?', (confirmed) => {
                        if (confirmed) {
                            state.expenses = state.expenses.filter(e => e.id !== id);
                            saveDataToCloud(() => { render(); if (tg && tg.HapticFeedback && tg.HapticFeedback.notificationOccurred) tg.HapticFeedback.notificationOccurred('success'); });
                        }
                    });
                } else {
                    if (confirm('Delete this expense?')) {
                        state.expenses = state.expenses.filter(e => e.id !== id);
                        saveDataToCloud(() => { render(); });
                    }
                }
            }

            // --- Initialization & event wiring ---
            try {
                if (tg && tg.expand) tg.expand();
                applyTheme();
                if (tg && tg.onEvent) tg.onEvent('themeChanged', applyTheme);
                if (tg && tg.onEvent) tg.onEvent('mainButtonClicked', handleFormSubmit);
            } catch (e) {
                console.warn('Telegram WebApp methods not available', e);
            }

            fab.addEventListener('click', () => openModal());
            modalOverlay.addEventListener('click', closeModal);
            reportModalOverlay.addEventListener('click', closeReportModalFunc);

            mainContent.addEventListener('click', (e) => {
                const item = e.target.closest('.list-item');
                if (item) {
                    const expense = state.expenses.find(ex => ex.id === item.dataset.id);
                    if (expense) {
                        if (tg && tg.showPopup) {
                            tg.showPopup({ title: 'á‡áŸ’ášá¾áŸášá¾áŸáŸá€á˜áŸ’á˜á—á¶á–', message: `á…áŸ†áá¶á™á›á¾ "${expense.notes || 'á‚áŸ’á˜á¶á“á€áŸ†áááŸ‹á…áŸ†áá¶áŸ†'}"`, buttons: [ {id: 'edit', type: 'default', text: 'á€áŸ‚áŸá˜áŸ’ášá½á›'}, {id: 'delete', type: 'destructive', text: 'á›á»á”'}, {type: 'cancel'} ] }, (buttonId) => {
                                if (buttonId === 'edit') { openModal(expense); }
                                else if (buttonId === 'delete') { deleteExpense(expense.id); }
                            });
                        } else {
                            const action = prompt('Type "edit" to edit or "delete" to delete this expense.');
                            if (action === 'edit') openModal(expense);
                            else if (action === 'delete') deleteExpense(expense.id);
                        }
                    }
                }
            });

            generateReportBtn.addEventListener('click', openReportModal);
            generateReportConfirm.addEventListener('click', (e) => { e.preventDefault(); generateDetailedReport(); });
            closeReportModal.addEventListener('click', closeReportModalFunc);

            // load cached local immediately (reduce flicker)
            try {
                const ls = localStorage.getItem('expenses');
                if (ls) {
                    const parsed = JSON.parse(ls);
                    state.expenses = Array.isArray(parsed) ? parsed : [];
                }
            } catch (e) {}

            // Load initial cloud/local data (termsAccepted and expenses)
            (async function loadInitialData() {
                const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
                if (user) welcomeMessageEl.textContent = `áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸ, ${user.first_name}!`;

                if (!isStorageSupported) {
                    render();
                    return;
                }

                try {
                    const values = await cloudGetItemsPromise(['expenses', 'termsAccepted']);
                    const proceed = async (storedExpensesValue) => {
                        await loadExpensesFromCloud(storedExpensesValue);
                        render();
                    };

                    if (!values.termsAccepted) {
                        if (tg && tg.showConfirm) {
                            tg.showConfirm(
                                "áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸ! á€á˜áŸ’á˜áœá·á’á¸á“áŸáŸ‡ášá€áŸ’áŸá¶á‘á·á“áŸ’á“á“áŸá™á…áŸ†áá¶á™ášá”áŸáŸ‹á¢áŸ’á“á€áŠáŸ„á™áŸá»áœááŸ’áá·á—á¶á–áŸ” áá¾á¢áŸ’á“á€á™á›áŸ‹á–áŸ’ášá˜á²áŸ’á™á€á˜áŸ’á˜áœá·á’á¸ášá€áŸ’áŸá¶á‘á·á“áŸ’á“á“áŸá™á€áŸ’á“á»á„ Telegram CloudStorage á¬á‘áŸ?",
                                (ok) => {
                                    if (ok) {
                                        tg.CloudStorage.setItem('termsAccepted', 'true', async () => { await proceed(values.expenses); });
                                    } else {
                                        if (tg && tg.close) tg.close();
                                    }
                                }
                            );
                        } else {
                            await cloudSetItemPromise('termsAccepted', 'true').catch(() => {});
                            await proceed(values.expenses);
                        }
                    } else {
                        await proceed(values.expenses);
                    }
                } catch (err) {
                    console.error('Error loading CloudStorage items:', err);
                    render();
                }
            })();
        }

        // --- App start (no blocking replacement if Telegram is absent) ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.ready === 'function') {
                    // call ready if available (safe)
                    window.Telegram.WebApp.ready();
                }
                // Initialize the app regardless; initializeApp is defensive and will work without Telegram
                initializeApp();
            } catch (e) {
                console.error('App startup error:', e);
                // Only show the startup failure message on real exceptions
                document.body.innerHTML = `<div class="h-screen flex items-center justify-center p-4 text-center" style="color: var(--hint-color);">á€á˜áŸ’á˜áœá·á’á¸á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá…á¶á”áŸ‹á•áŸ’áá¾á˜áŸ” áŸá¼á˜á–á·á“á·ááŸ’á™á€á»á„áŸá»á›áŸá˜áŸ’ášá¶á”áŸ‹á–áŸááŸŒá˜á¶á“á”á“áŸ’ááŸ‚á˜áŸ”</div>`;
            }
        });
    </script>
</body>
</html>
